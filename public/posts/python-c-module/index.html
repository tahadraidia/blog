<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | Let&#39;s build a Python module in C</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/python-c-module/" rel="bookmark"
           title="Permalink to Let&#39;s build a Python module in C">Let&#39;s build a Python module in C</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2020-10-04 00:00:00 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2020-10-04">Oct 4, 2020</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/c">C</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/python">Python</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/windows">Windows</a>
            
            
        </div>
</div>

<br>
<h2 id="background">Background</h2>
<p>Python is one of the most used programming language nowadays specially due its popularity in data science, deep and machine learning fields; Truth to be told, under the hood there is C and/or C++ code running.</p>
<p>Let&rsquo;s take for example some popular python libraries used in math and machine learn to illustrate that point:</p>
<ul>
<li><a href="https://github.com/numpy/numpy">Numpy</a> (33.2% of the code is written in C)</li>
<li><a href="https://github.com/tensorflow/tensorflow">TensorFlow</a> (61% of the code is written in C++)</li>
<li><a href="https://github.com/pytorch/pytorch">PyTorch</a> (53% of the code in written in C++ and 4% in C)</li>
</ul>
<p>The raison that these libraries are build in C and/or C++ is for performance issues mainly, also it is important to note that Python is written in C, hence it provides a C API to extend the language by creating new modules at lower-level possible.</p>
<h2 id="disclaimer">Disclaimer</h2>
<p>This blog post won&rsquo;t be an introduction to the internals of Python, however, I&rsquo;ll leave at the bottom of the page some useful resources on the subject if anyone is interested.</p>
<p>In this post, I am going to walk you through on how to write a minimalist Python module in C, however, since I believe that Hello Words' are boring, we are going to write a module that checks if a file is a valid PE (Portable Executable) using Windows API.</p>
<p>In order to follow with me, you will need a Windows machine with Visual Studio C++ and Python installed on the system.</p>
<h2 id="lets-start-coding-shall-we">Let&rsquo;s start coding, shall we?</h2>
<p>As mentioned earlier, we will see the minimalist C code required to build a module, basically a C module requires several things but most of all it needs:</p>
<ul>
<li>Function that makes up the core functionality of your C module</li>
<li>Definitions of the module and the methods of your C module</li>
<li>Initialize your C module</li>
</ul>
<p>Let&rsquo;s start by writing our core function that checks if a file is portable executable, we will use the following Windows API functions:</p>
<ul>
<li>CreateFileA</li>
<li>CreateFileMapping</li>
<li>MapViewOfFile</li>
<li>UnmapViewOfFile</li>
<li>CloseHandle</li>
</ul>
<p>The function takes a parameter and returns True if the file is a PE, False otherwise;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">static</span> PyObject<span style="color:#f92672">*</span> <span style="color:#a6e22e">isValidPE</span>(PyObject <span style="color:#f92672">*</span>self, PyObject<span style="color:#f92672">*</span> args)
{
	LPSTR pfile <span style="color:#f92672">=</span>  NULL;

	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>PyArg_ParseTuple(args, <span style="color:#e6db74">&#34;s&#34;</span>, <span style="color:#f92672">&amp;</span>pfile))
	{
      		<span style="color:#66d9ef">return</span> Py_None;
	}

	<span style="color:#75715e">// Get file handler.
</span><span style="color:#75715e"></span>	HANDLE hFile <span style="color:#f92672">=</span> CreateFileA(
		pfile,
		GENERIC_READ,
		FILE_SHARE_READ,
		NULL,
		OPEN_EXISTING,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);

	<span style="color:#75715e">// Error check.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(hFile <span style="color:#f92672">==</span> INVALID_HANDLE_VALUE)
	{
		PyErr_SetString(PyExc_ValueError, <span style="color:#e6db74">&#34;CreateFileA retuned INVALID_HANDLE_VALUE.&#34;</span>);
		<span style="color:#66d9ef">return</span> Py_None;
	}

	<span style="color:#75715e">// Map the EXE file.
</span><span style="color:#75715e"></span>	HANDLE hMapFile <span style="color:#f92672">=</span> CreateFileMapping(
		hFile,
		NULL,
		PAGE_READONLY,
		<span style="color:#ae81ff">0</span>,
		<span style="color:#ae81ff">0</span>,
		NULL
	);

	<span style="color:#75715e">// Error check.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(hMapFile <span style="color:#f92672">==</span> NULL)
	{
		PyErr_SetString(PyExc_ValueError, <span style="color:#e6db74">&#34;CreateFileMapping retuned NULL.&#34;</span>);
		<span style="color:#66d9ef">return</span> Py_None;
	}

	<span style="color:#75715e">// Get the base address.
</span><span style="color:#75715e"></span>	LPVOID lpBase <span style="color:#f92672">=</span> MapViewOfFile(
		hMapFile,
		FILE_MAP_READ,
		<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);

	<span style="color:#75715e">// Error check.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(lpBase <span style="color:#f92672">==</span> NULL)
	{
		PyErr_SetString(PyExc_ValueError, <span style="color:#e6db74">&#34;MapViewOfFile retuned NULL.&#34;</span>);
		<span style="color:#66d9ef">return</span> Py_None;
	}

	PIMAGE_DOS_HEADER dosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)lpBase;

	<span style="color:#75715e">// Clean up. 
</span><span style="color:#75715e"></span>	UnmapViewOfFile(hMapFile);
	CloseHandle(hMapFile);
	CloseHandle(hFile);
	
	<span style="color:#75715e">// Either True or False.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> dosHeader<span style="color:#f92672">-&gt;</span>e_magic <span style="color:#f92672">==</span> IMAGE_DOS_SIGNATURE <span style="color:#f92672">?</span> Py_True : Py_False;
}
</code></pre></div><p>The function returns <code>PyObject</code>  which is an object structure that you use to define object types in Python; All other object types are extensions of this type.</p>
<p>On our function we used the following Python object structures:</p>
<ul>
<li>PyObject (equivalent to Object in Java)</li>
<li>PyArg_ParseTyple (used to parse function arguments)</li>
<li>PyNone (equivalent to NULL in C)</li>
<li>PyErr_SetString (used to raise error)</li>
<li>Py_True (Python object that represents true)</li>
<li>Py_False (Python object that represents false)</li>
</ul>
<p>Now that we wrote the core functionality of the module, let&rsquo;s define our function using <code>PyMethodDef</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">static</span> PyMethodDef pevalidator_module_methods[] <span style="color:#f92672">=</span> {
    {<span style="color:#e6db74">&#34;isValidPE&#34;</span>, (PyCFunction)isValidPE, METH_VARARGS, <span style="color:#e6db74">&#34;This method checks if a file is  a valid PE.&#34;</span>},
    {NULL, NULL, <span style="color:#ae81ff">0</span>, NULL}
};
</code></pre></div><ul>
<li><strong>&ldquo;isValidPE&rdquo;</strong> is the name we will use to invoke this particular function</li>
<li><strong>(PyCFunction)isValidPE</strong> is the name of the C function to invoke</li>
<li><strong>METH_VARARGS</strong> is a flag that tells Python interpreter that this function take arguments</li>
<li>The last parameter is a string used to represent the method docstring</li>
</ul>
<p>Next step is to define our module:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> PyModuleDef pevalidator_module <span style="color:#f92672">=</span> {
    PyModuleDef_HEAD_INIT,
    <span style="color:#e6db74">&#34;pevalidator&#34;</span>,
    <span style="color:#e6db74">&#34;This module checks if a file is PE file.&#34;</span>,
    <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
    pevalidator_module_methods
};
</code></pre></div><ul>
<li><strong>PyModuleDef_HEAD_INIT</strong> advised to have</li>
<li><strong>&ldquo;pevalidator&rdquo;</strong> is the name of the C module</li>
<li>A string used to represent the module&rsquo;s description docstring</li>
<li><strong>-1</strong> represents an amount of memory needed to store the program state</li>
<li><strong>pevalidator_module_methods</strong> reference to the methods table, the one we defined earlier</li>
</ul>
<p>We are almost there! In order to build and import the module we will use <code>distrutils</code> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> distutils.core <span style="color:#f92672">import</span> setup, Extension

setup(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pevalidator&#34;</span>, version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0&#34;</span>, ext_modules<span style="color:#f92672">=</span>[Extension(<span style="color:#e6db74">&#39;pevalidator&#39;</span>,
    [<span style="color:#e6db74">&#39;pevalidator.c&#39;</span>])])
</code></pre></div><ul>
<li><strong>pevalidator</strong> is the name of the module</li>
<li><strong>[&lsquo;pevalidator.c&rsquo;]</strong> list of sources files relative to <code>setup.py</code>.</li>
</ul>
<p>Here is how to build the module:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\Users\tahai\code\python-c-module&gt; python .\setup.py build
running build
running build_ext
building <span style="color:#e6db74">&#39;pevalidator&#39;</span> extension
creating build
creating build\temp.win32-3.8
creating build\temp.win32-3.8\Release
C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.26.28801\bin\HostX86\x86\cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -IC<span style="color:#960050;background-color:#1e0010">:</span>\Users\tahai\AppData\Local\Programs\Python\Python38-32\include -IC<span style="color:#960050;background-color:#1e0010">:</span>\Users\tahai\AppData\Local\Programs\Python\Python38-32\include <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.26.28801\ATLMFC\include&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.26.28801\include&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Windows Kits\NETFXSDK\4.8\include\um&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Windows Kits\10\include\10.0.18362.0\ucrt&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Windows Kits\10\include\10.0.18362.0\shared&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Windows Kits\10\include\10.0.18362.0\um&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Windows Kits\10\include\10.0.18362.0\winrt&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Windows Kits\10\include\10.0.18362.0\cppwinrt&#34;</span> <span style="color:#e6db74">&#34;-IC:\Program Files (x86)\Fasm\INCLUDE&#34;</span> /Tcpevalidator.c /Fobuild\temp.win32-3.8\Release\pevalidator.obj
pevalidator.c
creating C:\Users\tahai\code\python-c-module\build\lib.win32-3.8
C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.26.28801\bin\HostX86\x86\link.exe /nologo /INCREMENTAL<span style="color:#960050;background-color:#1e0010">:</span>NO /LTCG /DLL /MANIFEST<span style="color:#960050;background-color:#1e0010">:</span>EMBED,ID=2 /MANIFESTUAC<span style="color:#960050;background-color:#1e0010">:</span>NO /LIBPATH<span style="color:#960050;background-color:#1e0010">:</span>C:\Users\tahai\AppData\Local\Programs\Python\Python38-32\libs /LIBPATH<span style="color:#960050;background-color:#1e0010">:</span>C:\Users\tahai\AppData\Local\Programs\Python\Python38-32\PCbuild\win32 <span style="color:#e6db74">&#34;/LIBPATH:C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.26.28801\ATLMFC\lib\x86&#34;</span> <span style="color:#e6db74">&#34;/LIBPATH:C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.26.28801\lib\x86&#34;</span> <span style="color:#e6db74">&#34;/LIBPATH:C:\Program Files (x86)\Windows Kits\NETFXSDK\4.8\lib\um\x86&#34;</span> <span style="color:#e6db74">&#34;/LIBPATH:C:\Program Files (x86)\Windows Kits\10\lib\10.0.18362.0\ucrt\x86&#34;</span> <span style="color:#e6db74">&#34;/LIBPATH:C:\Program Files (x86)\Windows Kits\10\lib\10.0.18362.0\um\x86&#34;</span> /EXPORT<span style="color:#960050;background-color:#1e0010">:</span>PyInit_pevalidator build\temp.win32-3.8\Release\pevalidator.obj /OUT<span style="color:#960050;background-color:#1e0010">:</span>build\lib.win32-3.8\pevalidator.cp38-win32.pyd /IMPLIB<span style="color:#960050;background-color:#1e0010">:</span>build\temp.win32-3.8\Release\pevalidator.cp38-win32.lib
   Creating library build\temp.win32-3.8\Release\pevalidator.cp38-win32.lib and object build\temp.win32-3.8\Release\pevalidator.cp38-win32.exp
Generating code
Finished generating code
PS C:\Users\tahai\code\python-c-module&gt;
</code></pre></div><p>Before we can import and use the module we need to install the module as fellow:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\Users\tahai\code\python-c-module&gt; python .\setup.py install
running install
running build
running build_ext
running install_lib
copying build\lib.win32-3.8\pevalidator.cp38-win32.pyd -&gt; C:\Users\tahai\AppData\Local\Programs\Python\Python38-32\Lib\site-packages
running install_egg_info
Removing C:\Users\tahai\AppData\Local\Programs\Python\Python38-32\Lib\site-packages\pevalidator-1.0-py3.8.egg-info
Writing C:\Users\tahai\AppData\Local\Programs\Python\Python38-32\Lib\site-packages\pevalidator-1.0-py3.8.egg-info
PS C:\Users\tahai\code\python-c-module&gt;
</code></pre></div><h2 id="in-action">In Action:</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\Users\tahai\code\python-c-module&gt; python
Python 3.8.5 (tags/v3.8.5<span style="color:#960050;background-color:#1e0010">:</span>580fbb0, Jul 20 2020, 15<span style="color:#960050;background-color:#1e0010">:</span>43<span style="color:#960050;background-color:#1e0010">:</span>08) [MSC v.1926 32 bit (Intel)] on win32
Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> or <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information.
&gt;&gt;&gt; import pevalidator as pev
&gt;&gt;&gt; pev.isValidPE(<span style="color:#e6db74">&#34;c:\\windows\\system32\\notepad.exe&#34;</span>)
True
&gt;&gt;&gt; pev.isValidPE(<span style="color:#e6db74">&#34;C:\\Users\\tahai\\code\\python-c-module\\setup.py&#34;</span>)
False
&gt;&gt;&gt; pev.isValidPE(<span style="color:#e6db74">&#34;C:\\doesnotexist.exe&#34;</span>)
ValueError<span style="color:#960050;background-color:#1e0010">:</span> CreateFileA retuned INVALID_HANDLE_VALUE.

The above exception was the direct cause of the following exception<span style="color:#960050;background-color:#1e0010">:</span>

Traceback (most recent call last)<span style="color:#960050;background-color:#1e0010">:</span>
  File <span style="color:#e6db74">&#34;&lt;stdin&gt;&#34;</span>, line 1, <span style="color:#66d9ef">in</span> &lt;module&gt;
SystemError<span style="color:#960050;background-color:#1e0010">:</span> &lt;built-in <span style="color:#66d9ef">function</span> isValidPE&gt; returned a result with an error set
&gt;&gt;&gt; exit()
PS C:\Users\tahai\code\python-c-module&gt;
</code></pre></div><h2 id="final-code">Final Code</h2>
<p>The final code is available at <a href="https://gist.github.com/tahadraidia/9c57146c35f0ba0fced39b80883ab2d1">https://gist.github.com/tahadraidia/9c57146c35f0ba0fced39b80883ab2d1</a></p>
<h2 id="useful-references">Useful References</h2>
<ul>
<li><a href="https://docs.python.org/3/c-api/index.html">https://docs.python.org/3/c-api/index.html</a></li>
<li><a href="https://realpython.com/build-python-c-extension-module/">https://realpython.com/build-python-c-extension-module/</a></li>
<li><a href="https://pg.ucsd.edu/cpython-internals.htm">https://pg.ucsd.edu/cpython-internals.htm</a></li>
<li><a href="https://medium.com/@dawranliou/getting-started-with-python-internals-a5474ccb8022">https://medium.com/@dawranliou/getting-started-with-python-internals-a5474ccb8022</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createfilemappinga">https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createfilemappinga</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-mapviewoffile">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-mapviewoffile</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea</a></li>
</ul>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
