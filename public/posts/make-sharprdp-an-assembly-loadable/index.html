<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | Make SharpRDP a .NET Assembly Loadable</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/make-sharprdp-an-assembly-loadable/" rel="bookmark"
           title="Permalink to Make SharpRDP a .NET Assembly Loadable">Make SharpRDP a .NET Assembly Loadable</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2021-11-29 07:21:19 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2021-11-29">Nov 29, 2021</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/osep">OSEP</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/pen300">PEN300</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/reverse-engineer">Reverse Engineer</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/c">C#</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/powershell">Powershell</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/.net-assembly">.NET Assembly</a>
            
            
        </div>
</div>

<br>
<p>SharpRDP in a neat tool when it comes to get a command execution via RDP protocol, The project is written in C# .NET, which makes perfect to leverage .NET Assembly, however, in order to load an assembly the binary needs to expose the API and in this case SharpRDP is build in away that it can only be in traditional way.</p>
<p>If we look at the source code of the project on github, we can clearly see that Program class has internal attributes and the two methods have private attribute. In order to make an Assembly loadable we need to make them public. We have two options here, the first one is to clone the project make the changes and compile it or use the current binary laying around and modified it using dnSpy.</p>
<p>We are going to choose the second option, this more straight forward process and easier to accomplish, the source code compilation requires some more steps, this is really not appealing and to be honest, I am not feeling to open Visual Studio today.</p>
<p><img src="/images/SharpRDP/OpenedInDnSPY.PNG" alt="original-code"></p>
<p>As mentioned earlier, Program class is internal and both HowTo() and Main() functions are private, we need to change all of them to public (Edit-&gt;Edit Class), also we need to keep the static part, thanks to static keyword we don&rsquo;t need to instantiate a new instance of the class.</p>
<p><img src="/images/SharpRDP/ChangeProgramClass.PNG" alt="updated-code"></p>
<p>Now, we need to save the changes, to do so go to Save module but before saving we need to change the Machine option to AMD64.</p>
<p><img src="/images/SharpRDP/ChangeARch2AMD64.PNG" alt="change-machine"></p>
<p>After this step we choose the location where to save the file and we are good to go!</p>
<p><img src="/images/SharpRDP/ChooseLocation2save.PNG" alt="save-location"></p>
<p>Before going any further in the process, we first need to check that the binary works.</p>
<p><img src="/images/SharpRDP/RunIt2makeSureItStillWorks.PNG" alt="save-location"></p>
<p>Amazing! the program still works as expected now it is time to write a Powershell script and load the assembly in memory.</p>
<p><img src="/images/SharpRDP/ScriptSourceCode.PNG" alt="script-source"></p>
<p>The script reads the file from dist but this could be trivially changed later on if needed, the main important part is namespace and class name along with the parameters passed to Main function. What we did here is simply translate the C# code into Powershell code (Referring to args).</p>
<p><img src="/images/SharpRDP/Perfecto.png" alt="running-script"></p>
<p>Perfecto! we made SharpRDP .NET Assembly loadable! This will come handy later on.</p>
<p>You can find the adaptation script made for the MSF script here:</p>
<p><a href="https://gist.github.com/tahadraidia/aa3ad6fdccd3b785b5788af641edbbe9">https://gist.github.com/tahadraidia/aa3ad6fdccd3b785b5788af641edbbe9</a></p>
<p>References:</p>
<ul>
<li><a href="https://github.com/0xthirteen/SharpRDP">https://github.com/0xthirteen/SharpRDP</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/standard/assembly/">https://docs.microsoft.com/en-us/dotnet/standard/assembly/</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load?view=net-6.0">https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load?view=net-6.0</a></li>
</ul>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
